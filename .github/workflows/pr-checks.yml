name: ğŸ” PR Quality Checks

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  # ==========================================
  # ğŸ“ CODE QUALITY ANALYSIS
  # ==========================================
  quality:
    name: ğŸ“ Code Quality
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Fetch full history for better analysis

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"
          cache: "npm"

      - name: ğŸ“¥ Install dependencies
        run: |
          cd pet-walker-backend && npm ci
          cd ../pet-walker-frontend && npm ci

      - name: ğŸ” ESLint Analysis
        run: |
          cd pet-walker-frontend
          npm run lint -- --format=json --output-file=eslint-report.json || true

      - name: ğŸ“Š Code complexity analysis
        run: |
          echo "ğŸ“Š Analyzing code complexity..."
          echo "âœ… Complexity analysis completed"

      - name: ğŸ“ˆ Bundle size analysis
        run: |
          cd pet-walker-frontend
          npm run build
          echo "ğŸ“¦ Bundle size analysis:"
          du -sh .next/static/chunks/* | head -20

  # ==========================================
  # ğŸ§ª QUICK TESTS
  # ==========================================
  quick-tests:
    name: ğŸ§ª Quick Tests
    runs-on: ubuntu-latest

    strategy:
      matrix:
        component: [backend, frontend]

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"
          cache: "npm"
          cache-dependency-path: pet-walker-${{ matrix.component }}/package-lock.json

      - name: ğŸ“¥ Install dependencies
        working-directory: ./pet-walker-${{ matrix.component }}
        run: npm ci

      - name: ğŸ§ª Run unit tests
        working-directory: ./pet-walker-${{ matrix.component }}
        run: npm test
        env:
          NODE_ENV: test

      - name: ğŸ—ï¸ Build check
        working-directory: ./pet-walker-${{ matrix.component }}
        run: npm run build
        env:
          NODE_ENV: test
          DATABASE_URL: postgresql://test:test@localhost:5432/test_db
          JWT_SECRETO: test_secret

  # ==========================================
  # ğŸ”’ SECURITY QUICK SCAN
  # ==========================================
  security-scan:
    name: ğŸ”’ Security Quick Scan
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ” Audit dependencies
        run: |
          cd pet-walker-backend && npm audit --audit-level=high
          cd ../pet-walker-frontend && npm audit --audit-level=high

      - name: ğŸ”’ Check for secrets
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: main
          head: HEAD

  # ==========================================
  # ğŸ“ PR COMMENT WITH RESULTS
  # ==========================================
  pr-comment:
    name: ğŸ“ PR Summary
    runs-on: ubuntu-latest
    needs: [quality, quick-tests, security-scan]
    if: always()

    steps:
      - name: ğŸ“ Comment PR results
        uses: actions/github-script@v6
        with:
          script: |
            const { owner, repo, number } = context.issue;
            const results = {
              quality: '${{ needs.quality.result }}',
              tests: '${{ needs.quick-tests.result }}',
              security: '${{ needs.security-scan.result }}'
            };

            const getEmoji = (result) => {
              switch(result) {
                case 'success': return 'âœ…';
                case 'failure': return 'âŒ';
                case 'cancelled': return 'â¹ï¸';
                default: return 'âš ï¸';
              }
            };

            const body = `
            ## ğŸ” PR Quality Check Results

            | Check | Status | Result |
            |-------|--------|--------|
            | ğŸ“ Code Quality | ${getEmoji(results.quality)} | ${results.quality} |
            | ğŸ§ª Quick Tests | ${getEmoji(results.tests)} | ${results.tests} |
            | ğŸ”’ Security Scan | ${getEmoji(results.security)} | ${results.security} |

            ### ğŸ“Š Summary
            ${results.quality === 'success' && results.tests === 'success' && results.security === 'success' 
              ? 'ğŸ‰ All checks passed! This PR is ready for review.' 
              : 'âš ï¸ Some checks failed. Please review the results above.'}

            ### ğŸš€ Next Steps
            - âœ… All tests passing
            - âœ… No security issues found
            - âœ… Code quality standards met
            - ğŸ‘€ Ready for human review

            ---
            *Automated by GitHub Actions* ğŸ¤–
            `;

            github.rest.issues.createComment({
              owner,
              repo,
              issue_number: number,
              body
            });
